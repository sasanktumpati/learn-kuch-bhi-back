# Quiz Module API (MVP)

This document describes the REST and WebSocket APIs for the in-memory quiz module. The quiz supports two modes:

- Topic AI mode: 10 multiple-choice questions are generated by an LLM.
- Math mode: Simple addition and integer division questions.

Two players maximum per room. Single-player works as well. No authentication is required.

Provider selection for AI questions is set by environment variables:

- `MODEL_PROVIDER` = `google` (default) or `openrouter`
- `GEMINI_API_KEY` for Google provider
- `OPENROUTER_API_KEY`, `OPENROUTER_MODEL` for OpenRouter provider

All endpoints are versioned under `/v1` (from `API_VERSION`).

## Data Models (Pydantic)

These are serialized to/from JSON. Enums are lowercase strings.

### QuizMode
- `"topic_ai"` or `"math"`

### QuizQuestion
- `question`: string
- `choices`: string[4]
- `correct_index`: number (0-based)

### QuizSpec
- `mode`: QuizMode
- `topic?`: string (required for `topic_ai` mode)
- `num_questions`: number (default 10)
- `time_per_question_sec`: number (default 30)
- Math-only fields:
  - `math_ops`: `"add"|"div"` list (default `["add","div"]`)
  - `min_value`: number (default 1)
  - `max_value`: number (default 99)
  - `division_integer_only`: boolean (default true)

### PlayerSummary
- `id`: string
- `name`: string
- `score`: number
- `ready`: boolean

### RoomStatus
- `"waiting" | "in_progress" | "ended"`

### RoomState
- `id`: string (room code)
- `spec`: QuizSpec
- `status`: RoomStatus
- `host_id`: string
- `players`: PlayerSummary[]
- `current_question_index`: number
- `total_questions`: number
- `question_expires_at?`: ISO-8601 string (UTC)
- `created_at`: ISO-8601 string (UTC)
- `started_at?`: ISO-8601 string (UTC)
- `ended_at?`: ISO-8601 string (UTC)
- `ready_count`: number
- `max_players`: number (=2)

## REST API

### List Rooms (Discovery)
GET `/v1/quiz/rooms`

Response 200:
```
[
  {
    "room_id": "ab12cd",
    "mode": "topic_ai",
    "status": "waiting",
    "players": 1,
    "max_players": 2,
    "ready_count": 0,
    "host_id": "h0s7id",
    "host_name": "Alice",
    "topic": "World Geography",
    "created_at": "2025-09-20T10:10:10Z",
    "started_at": null,
    "ended_at": null
  }
]
```

### Create Room
POST `/v1/quiz/rooms`

Request body:
```
{
  "host_name": "Alice",
  "mode": "topic_ai",        // or "math"
  "topic": "World Geography", // required for topic_ai
  "num_questions": 10,
  "time_per_question_sec": 30,
  // Math-only
  "math_ops": ["add","div"],
  "min_value": 1,
  "max_value": 99,
  "division_integer_only": true
}
```

Response 200 (questions are pre-generated on room creation):
```
{
  "room_id": "ab12cd",
  "player_id": "h0s7id",       // host player id
  "ws_url": "/v1/quiz/ws/ab12cd?player_id=h0s7id",
  "state": { ...RoomState }
}
```

### Join Room
POST `/v1/quiz/rooms/{room_id}/join`

Request body:
```
{ "display_name": "Bob" }
```

Response 200:
```
{
  "player_id": "p2id",
  "ws_url": "/v1/quiz/ws/ab12cd?player_id=p2id",
  "state": { ...RoomState }
}
```

Errors:
- 404 if room not found
- 409 if room is full (max 2)

### Get Room State
GET `/v1/quiz/rooms/{room_id}`

Response 200:
```
{ "state": { ...RoomState } }
```

Errors: 404 if room not found

### Start Room (Manual)
POST `/v1/quiz/rooms/{room_id}/start`

Response 200:
```
{ "ok": true, "state": { ...RoomState } }
```

This performs question generation based on `spec` and starts the game loop. Works for 1 or 2 players.

Errors: 404 if room not found, 400 on generation error

### Set Ready (Auto-start)
POST `/v1/quiz/rooms/{room_id}/players/{player_id}/ready?ready=true|false`

Response 200:
```
{ "state": { ...RoomState } }
```

When all present players are ready and the room is in `waiting`, the server automatically generates questions and starts the game.

Errors: 404 if room or player not found

## WebSocket API

Connect to: `/v1/quiz/ws/{room_id}?player_id={player_id}`

Upon connection, the server sends a `room_state` event with the current state.

### Client → Server messages

- Submit answer:
```
{ "type": "answer", "answer_index": 0 }
```

- Mark ready/unready:
```
{ "type": "ready", "ready": true }
```

### Server → Client events

- `room_state`
```
{ "type": "room_state", "data": { ...RoomState } }
```

- `question`
```
{
  "type": "question",
  "data": {
    "index": 0,
    "question": "What is the capital of France?",
    "choices": ["Paris","Lyon","Marseille","Nice"],
    "expires_at": "2025-09-20T11:11:11Z"
  }
}
```

- `answer_result`
  - Correct answer (first correct ends question):
```
{
  "type": "answer_result",
  "data": {
    "index": 0,
    "player_id": "h0s7id",
    "correct": true,
    "correct_index": 0,
    "scoreboard": [ { "player_id":"h0s7id", "name":"Alice", "score":1 }, ... ]
  }
}
```
  - Wrong answer:
```
{ "type":"answer_result", "data": { "index": 0, "player_id":"p2id", "correct": false } }
```
  - All players answered (no correct, or after last remaining wrong answer):
```
{ "type":"answer_result", "data": { "index": 0, "result": "all_answered", "correct_index": 2, "scoreboard": [ ... ] } }
```
  - Timeout (no correct within time):
```
{ "type":"answer_result", "data": { "index": 0, "result": "timeout" } }
```

- `end` (game over)
```
{
  "type": "end",
  "data": {
    "state": { ...RoomState },
    "scoreboard": [ { "player_id":"h0s7id","name":"Alice","score":7 }, { "player_id":"p2id","name":"Bob","score":3 } ]
  }
}
```

## Game Rules & Flow

- Max players per room: 2
- Ready flow:
  1. Host creates room and connects via WS.
  2. Guest joins and connects via WS.
  3. Each player sends `{type:"ready", ready:true}` or uses the REST `set ready` endpoint.
  4. When all connected players are ready and the room is `waiting`, the server auto-generates questions and starts the round.
  5. Alternatively, a client can manually start the room via the `start` endpoint.
- Questions are pre-generated at room creation based on mode/spec.
- Question timing: 30s default (configurable via `spec.time_per_question_sec`). The first correct answer ends the question immediately and awards 1 point.
- If all players have answered (even with no correct), the server advances to the next question immediately (no wait for timeout).
- Single-player: advances right after the player answers (correct or wrong).
- Scoring: only the first correct answer earns 1 point; no penalties for wrong answers.
- Ending: after `spec.num_questions` questions, the server emits an `end` event.

## Error Handling

- REST uses standard HTTP codes: `404` for not found, `409` on room full, `400` for generation issues.
- WebSocket ignores malformed messages; only `answer` and `ready` types are supported.
- Duplicate answers for the same question from the same player are ignored.

## Room Lifecycle & Cleanup

- In-memory only (no DB persistence for runtime).
- Idle auto-clean: rooms with no activity and no connections for 10 minutes, or rooms ended more than 10 minutes ago, are automatically removed. This runs every 60 seconds.

## Frontend Integration Notes

- Always open the WS using the `ws_url` returned by the server (includes `player_id`).
- After connecting, wait for `room_state`, then display a lobby with players and ready toggles.
- Once `question` arrives, start a client-side countdown to `expires_at`.
- Submit answers via WS `answer` messages; update UI on `answer_result` and `room_state`.
- On `end`, show final scoreboard and offer to create a new room.

## Examples

1) Create Topic AI room (Alice):
```
POST /v1/quiz/rooms
{
  "host_name": "Alice",
  "mode": "topic_ai",
  "topic": "World Geography"
}
```

2) Join room (Bob):
```
POST /v1/quiz/rooms/ab12cd/join
{ "display_name": "Bob" }
```

3) Ready via WS:
```
{ "type": "ready", "ready": true }
```

4) Answer via WS:
```
{ "type": "answer", "answer_index": 2 }
```
